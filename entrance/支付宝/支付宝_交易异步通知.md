#   目录
[TOC]
#   概述
通知 URL 是扫码，公众号，App章节中提交的参数 notify_url，支付完成后，银行会把相关支付和用户信息发送到该 URL，商户需要接收处理信息。

对后台通知交互时，如果收到商户的应答不是成功或超时，银行认为通知失败， 银行会通过一定的策略（如 30 分钟共 8 次）定期重新发起通知，尽可能提高通知的成功率，但不保证通知最终能成功。

由于存在重新发送后台通知的情况，因此同样的通知可能会多次发送给商户系统。 
==商户系统必须能够正确处理重复的通知==。

推荐的做法是:
>   当收到通知进行处理时， 首先检查对应业务数据的状态， 判断该通知是否已经处理过， 如果没有处理过再进行处理， 如果处理过直接返回结果成功。

>   在对业务数据进行状态检查和处理之前， 要采用数据锁进行并发控制， 以避免函数重入造成的数据混乱。

后台通知通过请求中的notify_url进行， POST方式给商户系统（==通知参数内容为JSON格式数据流==）

#   业务
##  通知结果参数列表
字段名| 变量名| 必填|类型|说明|
---|---|---|---|---|
返回状态码|return_code|是|varchar(16)|SUCCESS/ERROR_CODE
返回信息|return_msg|否|varchar(128)|返回信息
业务结果|result_code|是|varchar(16)|SUCCESS/ERROR_CODE
错误代码|err_code|否|varchar(32)|错误返回码
错误代码描述|err_code_des|否|varchar(128)|错误返回的信息描述
商户号|mch_id|是|varchar(32)|商户号，由银行分配
设备号|device_info|否|varchar(32)|银行支付分配的终端设备号
交易订单状态|trade_state|是|varchar(32)|下拉查看订单状态
交易类型|trade_type|是|varchar(16)|交易类型
支付宝订单号|alipay_transaction_id|是|varchar(64)|支付宝订单号
银行订单号|transaction_id|是|varchar(32)|银行交易号
商户订单号|out_trade_no|是|varchar(32)|商户系统内部的定单号
总金额|total_fee|是|Int(20)|总金额，以（分）为单位
支付完成时间|time_end|是|varchar(14)|格式:yyyyMMddHHmmss
随机字符串|nonce_str|是|varchar(32)|随机字符串
签名|sign|是|varchar(32)|详见签名规则


##  通知结果反馈
银行后台通过notify_url通知商户，商户做业务处理后，需要以==字符串==的形式反馈处理结果，内容如下：

返回结果 | 结果说明
---|---
SUCCESS|处理成功，银行系统收到此结果后不再进行后续通知
FAIL或其它字符|处理不成功，银行收到此结果或者没有收到任何结果，系统通过==补单机制==再次通知


#   补单机制
>   注意：对后台通知交互模式，如果银行收到商户的应答不是“SUCCESS”或超时，银行认为通知失败，银行会通过一定的策略（如30分钟共10次）定期重新发起通知，尽可能提高通知的成功率，但银行不保证通知最终能成功。

>   由于存在重新发送后台通知的情况，因此同样的通知可能会多次发送给商户系统。商户系统必须能够正确处理重复的通知。

银行推荐的做法是:
>   当收到通知进行处理时，首先检查对应业务数据的状态，判断该通知是否已经处理过，如果没有处理过再进行处理，如果处理过直接返回“SUCCESS”。在对业务数据进行状态检查和处理之前，要采用数据锁进行并发控制，以避免函数重入造成的数据混乱。

#   交易订单状态

订单状态| 状态描述|适用场景
---|---|---
INIT|订单初始化|全部
SUCCESS|支付成功|全部
REFUND|转入退款|全部
NOTPAY|未支付|全部
CLOSED|已关闭|扫码，公众号
REVOKED|已撤销|条码（微信-收付款，支付宝-付钱）
USERPAYING|用户支付中|全部
PAYERROR|支付失败(其他原因)|全部
FAIL|处理失败(其他原因)|全部
